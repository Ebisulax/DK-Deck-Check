<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload XML File</title>
    <style>
        .container {
            display: flex;
        }
        .card-list, .rule-check {
            margin: 20px;
            width: 50%;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .rule-check table {
            width: 100%;
        }
        .rule-check th, .rule-check td {
            text-align: center;
        }
        .rule-check th {
            background-color: #e6e6e6;
        }
    </style>
</head>
<body>
    <h1>Upload XML File</h1>
    <input type="file" id="fileInput" accept=".xml">
    <button onclick="uploadFile()">Upload</button>
    <div class="container">
        <div class="card-list">
            <table id="cardTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>ATK</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="rule-check">
            <table>
                <thead>
                    <tr>
                        <th>Regel</th>
                        <th>Erlaubt</th>
                        <th>Deck</th>
                        <th>Ergebnis</th>
                    </tr>
                </thead>
                <tbody>
                    <tr id="rule1">
                        <td>⌀ ATK deiner Monster</td>
                        <td>≤ 1200</td>
                        <td><span id="avgAtkValue"></span></td>
                        <td><span id="avgAtkResult"></span></td>
                    </tr>
                    <tr id="rule2">
                        <td>1700+ Monster</td>
                        <td>Anz.: 2, Summe ATK: 3650</td>
                        <td>Anz.: <span id="highAtkCount"></span>, Summe ATK: <span id="highAtkSum"></span></td>
                        <td><span id="highAtkResult"></span></td>
                    </tr>
                    <tr id="rule3">
                        <td>1500-1650 Monster</td>
                        <td>Anz.: 3, Summe ATK: 4700</td>
                        <td>Anz.: <span id="midAtkCount"></span>, Summe ATK: <span id="midAtkSum"></span></td>
                        <td><span id="midAtkResult"></span></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        async function fetchDatabase() {
            try {
                const response = await fetch('https://db.ygoprodeck.com/api/v7/cardinfo.php');
                const data = await response.json();
                return data.data;
            } catch (error) {
                console.error('Error fetching the database:', error);
                return [];
            }
        }

        async function uploadFile() {
            const input = document.getElementById('fileInput');
            const file = input.files[0];

            if (file) {
                const reader = new FileReader();
                reader.onload = async function(event) {
                    try {
                        const parser = new DOMParser();
                        const xml = parser.parseFromString(event.target.result, "application/xml");
                        
                        // Get all card elements within the <main> part
                        const mainElement = xml.getElementsByTagName('main')[0];
                        if (!mainElement) {
                            console.error('No <main> element found in the uploaded file.');
                            return;
                        }
                        
                        const mainCards = mainElement.getElementsByTagName('card');
                        const database = await fetchDatabase();

                        // Get the table body element
                        const cardTableBody = document.getElementById('cardTable').querySelector('tbody');
                        cardTableBody.innerHTML = ''; // Clear the table

                        let totalAtk = 0;
                        let count = 0;
                        let highAtkCount = 0;
                        let highAtkSum = 0;
                        let midAtkCount = 0;
                        let midAtkSum = 0;

                        // Loop through the cards and add their values to the list
                        for (let i = 0; i < mainCards.length; i++) {
                            const cardName = mainCards[i].textContent.trim();
                            const tableRow = document.createElement('tr');
                            const nameCell = document.createElement('td');
                            const atkCell = document.createElement('td');
                            nameCell.textContent = cardName;

                            // Find match in database
                            const match = database.find(dbCard => dbCard.name === cardName);
                            if (match && typeof match.atk === 'number') {
                                const originalAtk = match.atk;
                                const level = match.level;

                                // Adjust ATK based on level for calculation purposes
                                let adjustedAtk = originalAtk;
                                if (level >= 5 && level <= 6) {
                                    adjustedAtk = Math.max(adjustedAtk - 600, 0);
                                } else if (level >= 7) {
                                    adjustedAtk = Math.max(adjustedAtk - 1000, 0);
                                }

                                atkCell.textContent = originalAtk;

                                // Include in average calculation
                                totalAtk += adjustedAtk;
                                count++;

                                if (level >= 1 && level <= 4) {
                                    if (originalAtk >= 1700) {
                                        highAtkCount++;
                                        highAtkSum += originalAtk;
                                    } else if (originalAtk >= 1500 && originalAtk <= 1650) {
                                        midAtkCount++;
                                        midAtkSum += originalAtk;
                                    }
                                }
                            } else {
                                atkCell.textContent = '';
                            }

                            tableRow.appendChild(nameCell);
                            tableRow.appendChild(atkCell);
                            cardTableBody.appendChild(tableRow);
                        }

                        // Calculate average ATK
                        const avgAtk = count > 0 ? Math.ceil(totalAtk / count) : 0;

                        // Function to create a check or cross icon
                        function createIcon(isCheck) {
                            const icon = document.createElement('img');
                            icon.src = isCheck ? 'https://img.icons8.com/color/48/000000/checkmark.png' : 'https://img.icons8.com/color/48/000000/cancel.png';
                            icon.alt = isCheck ? 'Check' : 'Cross';
                            icon.width = 24;
                            icon.height = 24;
                            return icon;
                        }

                        // Check rule 1
                        const rule1Value = document.getElementById('avgAtkValue');
                        const rule1Result = document.getElementById('avgAtkResult');
                        rule1Value.textContent = `${avgAtk}`;
                        rule1Result.innerHTML = '';
                        rule1Result.appendChild(createIcon(avgAtk <= 1200));

                        // Check rule 2
                        const rule2Value = document.getElementById('highAtkCount');
                        const rule2Sum = document.getElementById('highAtkSum');
                        const rule2Result = document.getElementById('highAtkResult');
                        rule2Value.textContent = `${highAtkCount}`;
                        rule2Sum.textContent = `${highAtkSum}`;
                        rule2Result.innerHTML = '';
                        rule2Result.appendChild(createIcon(highAtkCount <= 2 && highAtkSum <= 3650));

                        // Check rule 3
                        const rule3Value = document.getElementById('midAtkCount');
                        const rule3Sum = document.getElementById('midAtkSum');
                        const rule3Result = document.getElementById('midAtkResult');
                        rule3Value.textContent = `${midAtkCount}`;
                        rule3Sum.textContent = `${midAtkSum}`;
                        rule3Result.innerHTML = '';
                        rule3Result.appendChild(createIcon(midAtkCount <= 3 && midAtkSum <= 4700));
                    } catch (error) {
                        console.error('Error parsing XML:', error);
                    }
                };
                reader.readAsText(file);
            } else {
                console.error('No file selected');
            }
        }
    </script>
</body>
</html>
